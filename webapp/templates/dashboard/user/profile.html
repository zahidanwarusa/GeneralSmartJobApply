{% extends "dashboard/base.html" %}
{% from 'dashboard/components/avatar.html' import avatar %}
{% block title %}Profile - SmartApply{% endblock %}
{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 fw-bold">My Profile</h1>
            <p class="text-muted mb-0">Manage your personal information and profile settings</p>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <div class="row">
            <!-- Profile Picture Card -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title fw-bold mb-4">Profile Picture</h5>

                        <!-- Profile Picture Preview -->
                        <div class="mb-4">
                            <div class="position-relative d-inline-block" id="avatarContainer">
                                {% if current_user.profile_picture %}
                                    {% if 'supabase' in current_user.profile_picture or 'http' in current_user.profile_picture %}
                                    <img id="profilePreview" src="{{ current_user.profile_picture }}"
                                         alt="Profile Picture"
                                         class="rounded-circle border border-3 border-primary"
                                         style="width: 180px; height: 180px; object-fit: cover;">
                                    {% else %}
                                    <img id="profilePreview" src="{{ url_for('static', filename=current_user.profile_picture) }}"
                                         alt="Profile Picture"
                                         class="rounded-circle border border-3 border-primary"
                                         style="width: 180px; height: 180px; object-fit: cover;">
                                    {% endif %}
                                {% else %}
                                    {# Show letter avatar by default #}
                                    <div id="profilePreview">
                                        {{ avatar(current_user, size='180px', border=true) }}
                                    </div>
                                {% endif %}

                                <!-- Camera Icon Overlay -->
                                <label for="profile_picture" class="position-absolute bottom-0 end-0 mb-2 me-2 btn btn-primary btn-sm rounded-circle"
                                       style="width: 45px; height: 45px; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center;">
                                    <i class="bx bx-camera fs-5"></i>
                                </label>
                            </div>
                        </div>

                        <!-- File Input (Hidden) -->
                        <input type="file" id="profile_picture" name="profile_picture"
                               accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                               class="d-none">

                        <!-- Info Text -->
                        <p class="text-muted small mb-0">
                            <i class="bx bx-info-circle me-1"></i>
                            Allowed formats: PNG, JPG, JPEG, GIF, WEBP
                        </p>
                        <p class="text-muted small">Max size: 5MB</p>

                        <!-- User Info -->
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="fw-bold mb-1">{{ current_user.full_name or current_user.username }}</h6>
                            <p class="text-muted small mb-2">{{ current_user.email }}</p>
                            <span class="badge bg-success bg-opacity-10 text-success">
                                <i class="bx bx-check-circle me-1"></i>
                                {{ 'Email Verified' if current_user.email_verified else 'Active' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Information Card -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-4">Personal Information</h5>

                        <div class="row">
                            <!-- Full Name -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-user me-1 text-primary"></i>Full Name
                                </label>
                                <input type="text" name="full_name" class="form-control"
                                       value="{{ current_user.full_name or '' }}"
                                       placeholder="Enter your full name">
                            </div>

                            <!-- Username -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-at me-1 text-primary"></i>Username
                                </label>
                                <input type="text" class="form-control"
                                       value="{{ current_user.username }}"
                                       disabled>
                                <small class="text-muted">Username cannot be changed</small>
                            </div>

                            <!-- Email -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-envelope me-1 text-primary"></i>Email Address
                                </label>
                                <input type="email" class="form-control"
                                       value="{{ current_user.email }}"
                                       disabled>
                                <small class="text-muted">Email cannot be changed</small>
                            </div>

                            <!-- Date of Birth -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-calendar me-1 text-primary"></i>Date of Birth
                                </label>
                                <input type="date" name="date_of_birth" class="form-control"
                                       value="{{ current_user.date_of_birth.strftime('%Y-%m-%d') if current_user.date_of_birth else '' }}">
                            </div>

                            <!-- Gender -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-male-female me-1 text-primary"></i>Gender
                                </label>
                                <select name="gender" class="form-select">
                                    <option value="">Select gender</option>
                                    <option value="male" {% if current_user.gender == 'male' %}selected{% endif %}>Male</option>
                                    <option value="female" {% if current_user.gender == 'female' %}selected{% endif %}>Female</option>
                                    <option value="other" {% if current_user.gender == 'other' %}selected{% endif %}>Other</option>
                                    <option value="prefer_not_to_say" {% if current_user.gender == 'prefer_not_to_say' %}selected{% endif %}>Prefer not to say</option>
                                </select>
                            </div>

                            <!-- Country -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-globe me-1 text-primary"></i>Country
                                </label>
                                <input type="text" name="country" class="form-control"
                                       value="{{ current_user.country or '' }}"
                                       placeholder="Enter your country">
                            </div>

                            <!-- Language -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bx bx-message-square-dots me-1 text-primary"></i>Preferred Language
                                </label>
                                <select name="language" class="form-select">
                                    <option value="">Select language</option>
                                    <option value="en" {% if current_user.language == 'en' %}selected{% endif %}>English</option>
                                    <option value="es" {% if current_user.language == 'es' %}selected{% endif %}>Spanish</option>
                                    <option value="fr" {% if current_user.language == 'fr' %}selected{% endif %}>French</option>
                                    <option value="de" {% if current_user.language == 'de' %}selected{% endif %}>German</option>
                                    <option value="zh" {% if current_user.language == 'zh' %}selected{% endif %}>Chinese</option>
                                    <option value="ja" {% if current_user.language == 'ja' %}selected{% endif %}>Japanese</option>
                                    <option value="ko" {% if current_user.language == 'ko' %}selected{% endif %}>Korean</option>
                                    <option value="pt" {% if current_user.language == 'pt' %}selected{% endif %}>Portuguese</option>
                                    <option value="ar" {% if current_user.language == 'ar' %}selected{% endif %}>Arabic</option>
                                    <option value="hi" {% if current_user.language == 'hi' %}selected{% endif %}>Hindi</option>
                                </select>
                            </div>
                        </div>

                        <!-- Account Information -->
                        <div class="mt-4 pt-4 border-top">
                            <h6 class="fw-bold mb-3">Account Information</h6>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <small class="text-muted">Member Since:</small>
                                    <p class="mb-0 fw-semibold">
                                        {{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}
                                    </p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <small class="text-muted">Last Login:</small>
                                    <p class="mb-0 fw-semibold">
                                        {{ current_user.last_login.strftime('%B %d, %Y %I:%M %p') if current_user.last_login else 'N/A' }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-4 pt-3 border-top d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="bx bx-save me-2"></i>Save Changes
                            </button>
                            <a href="{{ url_for('dashboard.user_index') }}" class="btn btn-outline-secondary flex-fill">
                                <i class="bx bx-x me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Profile picture preview
document.getElementById('profile_picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            e.target.value = '';
            return;
        }

        // Validate file type
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Please upload a valid image file (PNG, JPG, JPEG, GIF, WEBP)');
            e.target.value = '';
            return;
        }

        // Preview the image
        const reader = new FileReader();
        reader.onload = function(event) {
            const previewContainer = document.getElementById('profilePreview');

            // Replace content with img element
            previewContainer.innerHTML = '<img src="' + event.target.result + '" alt="Profile Picture" class="rounded-circle border border-3 border-primary" style="width: 180px; height: 180px; object-fit: cover;">';
        };
        reader.readAsDataURL(file);
    }
});
</script>

<style>
.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

input.form-control:disabled,
select.form-select:disabled {
    background-color: #f8f9fa;
    cursor: not-allowed;
}

.form-label {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.15);
}
</style>
{% endblock %}
